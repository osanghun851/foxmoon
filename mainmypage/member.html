<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>회원정보 입력</title>
<link href="https://fonts.googleapis.com/css2?family=Gugi&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }

:root{
  --labelW: 14dvh;   /* 라벨 영역 고정 너비 */
  --gapX: 1.2dvh;    /* 입력칸 간격 (모든 행 동일) */
}

/* 바깥: 흰색 / 안쪽: 9:16 캔버스 */
html,body{
  margin:0; padding:0;
  height:100dvh; width:100vw;
  display:flex; justify-content:center; align-items:center;
  background:#fff;
  font-family:'Gugi', sans-serif;
}
.canvas{
  position:relative;
  width:100%;
  max-width:calc(100dvh * 9 / 16); /* 9:16 유지 */
  height:100dvh;
  background: radial-gradient(120dvh 120dvh at 30% 0%, #4970a8, #1f2b46 70%);
  overflow:hidden;
  display:flex; flex-direction:column;
  align-items:center;
}

/* 상단 타이틀 */
.title{
  text-align:center; color:#fff; margin-top:4dvh;
  font-size:3.8dvh; letter-spacing:.06em;
}
.subtitle{
  text-align:center; color:#e7eef8cc; margin-top:.8dvh; font-size:1.6dvh;
}

/* 안쪽 카드 → 세로 중앙 배치 */
.card{
  margin-top:auto; margin-bottom:auto; /* 화면 세로 중앙 */
  width:calc(100% - 6dvh);
  background:#fff; border-radius:4.2dvh;
  padding:4dvh 4dvh 4dvh 3.2dvh;
  box-shadow:0 1dvh 2dvh rgba(0,0,0,.08) inset;
  display:flex; flex-direction:column;
  height:75dvh;
}

/* 한 줄 레이아웃 기본 */
.row{
  display:grid;
  gap:var(--gapX); align-items:center;
  margin-bottom:2.2dvh;
}

/* 라벨 */
.label-col{ width:var(--labelW); }
.label-pill{
  background:#0e3259; color:#fff; text-align:center;
  border-radius:1.4dvh; min-height:4.2dvh;
  font-size:1.8dvh; padding:.7dvh .9dvh;
  display:flex; align-items:center; justify-content:center;
  width:100%;
}

/* 입력/선택 공통 */
input[type="text"], input[type="password"], select{
  width:100%; height:4.6dvh;
  font-size:2.0dvh;
  color:#222; padding:0 1.4dvh;
  border:.26dvh solid #9fa6b2; background:#fff; outline:none;
  border-radius:0;
}

/* select 화살표 */
select{
  -webkit-appearance:none; appearance:none;
  padding-right:5dvh;
  background-image: linear-gradient(45deg, transparent 50%, #333 50%),
                    linear-gradient(135deg, #333 50%, transparent 50%),
                    linear-gradient(to right, transparent, transparent);
  background-position: calc(100% - 2.3dvh) 1.7dvh, calc(100% - 1.5dvh) 1.7dvh, 0 0;
  background-size: .9dvh .9dvh, .9dvh .9dvh, 100% 100%;
  background-repeat:no-repeat;
}

.at{ font-size:2.2dvh; color:#888; text-align:center; }

/* 버튼 */
.btn, .btn-join{ font-family:'Gugi', sans-serif; }
.btn{
  height:4.6dvh; padding:0 1.6dvh;
  font-size:1.6dvh;
  border:.26dvh solid #222; background:#fff; color:#222;
  border-radius:0; cursor:pointer; white-space:nowrap;
}
.submit-wrap{ display:flex; justify-content:center; margin-top:3dvh; }
.btn-join{
  width:80%; height:5.5dvh;
  font-size:2.4dvh; color:#222; background:#efefef;
  border:none; border-radius:2.2dvh; cursor:pointer; box-shadow:0 .7dvh 0 #4a4a4a;
}
.btn-join:active{ transform:translateY(.7dvh); box-shadow:none; }

/* ===== 그리드 ===== */
.row.name-row{
  grid-template-columns: var(--labelW) 1fr 1fr;
}
.row.single{
  grid-template-columns: var(--labelW) 1fr;
}
.row.addr-row{
  grid-template-columns: var(--labelW) 1fr 1fr;
}
.row.email-row{
  grid-template-columns: var(--labelW) 2fr auto 2fr;
}
.row.id-row{
  grid-template-columns: var(--labelW) 1fr auto;
}
#usernameMsg{
  width: 100dvh;
  font-size: 2dvh;
  opacity: 0.7;
}

</style>
</head>
<body>
  <div class="canvas">
    <div class="title">회원정보 입력</div>
    <div class="subtitle">회원 가입을 위해 필요한 정보를 입력해주세요.</div>

    <form class="card" id="joinForm">

      <!-- 이름 -->
      <div class="row name-row">
        <div class="label-pill label-col">이름</div>
        <input type="text" id="lastName" placeholder="성" autocomplete="family-name" required>
        <input type="text" id="firstName" placeholder="이름" autocomplete="given-name" required>
      </div>

      <!-- 생년월일 -->
      <div class="row single">
        <div class="label-pill label-col">생년월일</div>
        <input type="text" id="birth" placeholder="YYYYMMDD"
               maxlength="8" inputmode="numeric" pattern="[0-9]{8}"
               title="YYYYMMDD 형식(예: 20040507)으로 입력하세요." required>
      </div>

      <!-- 주소지 -->
      <div class="row addr-row">
        <div class="label-pill label-col">주소지</div>
        <select id="sido" required>
          <option value="">시/도 선택</option>
          <option>서울특별시</option><option>부산광역시</option>
          <option>대구광역시</option><option>인천광역시</option>
          <option>광주광역시</option><option>대전광역시</option>
          <option>울산광역시</option><option>세종특별자치시</option>
          <option>경기도</option><option>강원특별자치도</option>
          <option>충청북도</option><option>충청남도</option>
          <option>전라북도</option><option>전라남도</option>
          <option>경상북도</option><option>경상남도</option>
          <option>제주특별자치도</option>
        </select>
        <select id="sigungu" required>
          <option value="">구/군 선택</option>
        </select>
      </div>

      <!-- 이메일 -->
      <div class="row email-row">
        <div class="label-pill label-col">이메일</div>
        <input type="text" id="emailId" placeholder="example" autocomplete="off" required>
        <div class="at">@</div>
        <select id="emailDomain" required>
          <option value="">도메인 선택</option>
          <option>gmail.com</option>
          <option>naver.com</option>
          <option>daum.net</option>
          <option>hanmail.net</option>
          <option>kakao.com</option>
          <option>outlook.com</option>
          <option>icloud.com</option>
          <option>yahoo.com</option>
          <option>khu.ac.kr</option>
        </select>
      </div>

      <!-- 아이디 -->
      <div class="row id-row">
        <div class="label-pill label-col">아이디</div>
        <input type="text" id="userid" placeholder="아이디 입력" required>
        <br>
        <span id="usernameMsg"></span>
      </div>

      <!-- 비밀번호 -->
      <div class="row single">
        <div class="label-pill label-col">비밀번호</div>
        <input type="password" id="pw" placeholder="비밀번호" required>
      </div>

      <!-- 비밀번호 확인 -->
      <div class="row single">
        <div class="label-pill label-col">비밀번호 확인</div>
        <input type="password" id="pw2" placeholder="비밀번호 확인" required>
      </div>

      <!-- 가입 버튼 -->
      <div class="submit-wrap">
        <button type="submit" class="btn-join">회원가입</button>
      </div>
    </form>
  </div>

<script>
  const BACKEND_URL="https://foxmoonbackend.onrender.com"
  /* ===== 시/군/구 데이터 ===== */
  const REGION_MAP = {
    '서울특별시': ['강남구','강동구','강북구','강서구','관악구','광진구','구로구','금천구','노원구','도봉구','동대문구','동작구','마포구','서대문구','서초구','성동구','성북구','송파구','양천구','영등포구','용산구','은평구','종로구','중구','중랑구'],
    '부산광역시': ['해운대구','수영구','연제구','동래구','부산진구','남구','금정구','사하구','사상구','북구','영도구','중구','서구','강서구','기장군'],
    '대구광역시': ['수성구','달서구','동구','북구','중구','서구','남구','달성군','군위군'],
    '인천광역시': ['연수구','남동구','부평구','미추홀구','계양구','서구','중구','동구','강화군','옹진군'],
    '광주광역시': ['서구','북구','동구','남구','광산구'],
    '대전광역시': ['서구','유성구','중구','동구','대덕구'],
    '울산광역시': ['남구','중구','동구','북구','울주군'],
    '세종특별자치시': ['세종시'],
    '경기도': ['수원시','성남시','용인시','안양시','부천시','광명시','과천시','평택시','의정부시','구리시','남양주시','하남시','고양시','파주시','김포시','의왕시','시흥시','군포시','안산시','오산시','화성시','광주시','양주시','포천시','이천시','여주시','양평군','가평군','연천군'],
    '강원특별자치도': ['춘천시','원주시','강릉시','동해시','속초시','삼척시','홍천군','횡성군','영월군','평창군','정선군','철원군','화천군','양구군','인제군','고성군','양양군'],
    '충청북도': ['청주시','충주시','제천시','보은군','옥천군','영동군','증평군','진천군','괴산군','음성군','단양군'],
    '충청남도': ['천안시','공주시','보령시','아산시','서산시','논산시','계룡시','당진시','금산군','부여군','서천군','청양군','홍성군','예산군','태안군'],
    '전라북도': ['전주시','군산시','익산시','정읍시','남원시','김제시','완주군','진안군','무주군','장수군','임실군','순창군','고창군','부안군'],
    '전라남도': ['목포시','여수시','순천시','나주시','광양시','담양군','곡성군','구례군','고흥군','보성군','화순군','장흥군','강진군','해남군','영암군','무안군','함평군','영광군','장성군','완도군','진도군','신안군'],
    '경상북도': ['포항시','경주시','김천시','안동시','구미시','영주시','영천시','상주시','문경시','경산시','군위군','의성군','청송군','영양군','영덕군','청도군','고령군','성주군','칠곡군','예천군','봉화군','울진군','울릉군'],
    '경상남도': ['창원시','김해시','진주시','양산시','거제시','통영시','사천시','밀양시','의령군','함안군','창녕군','고성군','남해군','하동군','산청군','함양군','거창군','합천군'],
    '제주특별자치도': ['제주시','서귀포시']
  };

  const sido = document.getElementById('sido');
  const sigungu = document.getElementById('sigungu');
  sido.addEventListener('change', () => {
    const list = REGION_MAP[sido.value] || [];
    sigungu.innerHTML = '<option value="">구/군 선택</option>' +
      list.map(g => `<option>${g}</option>`).join('');
  });
    const useridInput = document.getElementById("userid");
  const usernameMsg = document.getElementById("usernameMsg");
  let timer;

  /* 아이디 중복확인 */
  document.getElementById('userid').addEventListener('input', () => {
    clearTimeout(timer); // 타이핑 중복 방지 (디바운스)
    const username = useridInput.value.trim();

    if (!username) {
      usernameMsg.textContent = "";
      return;
    }

    // 0.5초 동안 입력이 멈추면 서버에 요청
    timer = setTimeout(async () => {
      try {
        const res = await fetch(BACKEND_URL+`/check-username?username=${encodeURIComponent(username)}`,{credentials:"include"});
        const data = await res.json();

        if (data.available) {
          usernameMsg.textContent = data.message;
          usernameMsg.style.color = "green";
        } else {
          usernameMsg.textContent = data.message;
          usernameMsg.style.color = "red";
        }
      } catch (err) {
        usernameMsg.textContent = "서버 오류 발생";
        usernameMsg.style.color = "red";
      }
    }, 500);
  });

  /* 제출 검증 */
  document.getElementById('joinForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const username = document.getElementById('userid').value.trim();

    const lastName = document.getElementById("lastName").value.trim();
    const firstName = document.getElementById("firstName").value.trim();
    const Rname = lastName+firstName;
    console.log(Rname);

    const sido = document.getElementById('sido').value;
    const sigungu = document.getElementById('sigungu').value;
    const address = sido+'/'+sigungu;

    const birth = document.getElementById('birth').value.trim();
    if(!/^[0-9]{8}$/.test(birth)){
      alert('생년월일은 숫자 8자리(YYYYMMDD)로 입력하세요.');
      e.preventDefault(); return;
    }
    const pw = document.getElementById('pw').value;
    const pw2 = document.getElementById('pw2').value;
    if(pw !== pw2){
      alert('비밀번호와 비밀번호 확인이 일치하지 않습니다. 회원가입이 불가합니다.');
      e.preventDefault(); return;
    }

    const emailId = document.getElementById('emailId').value.trim();
    const emailDomain = document.getElementById('emailDomain').value;
    if(!emailId || !emailDomain){
      alert('이메일을 입력/선택해주세요.');
      e.preventDefault(); return;
    }
    const email = `${emailId}@${emailDomain}`;
    try{
      const response = await fetch(BACKEND_URL+"/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, pw, Rname,  address, birth, email }),
      credentials: "include" // 세션 쿠키 포함
    });
    const data = await response.json();

    if (!response.ok) {
      // 서버에서 보낸 에러 메시지 보여주기
      alert("회원가입 실패: " + data.error);
      return;
    }
    alert('회원가입이 완료되었습니다!\n이메일: ' + email);
    e.preventDefault(); // 데모용
    }catch (err){
      alert(err);
      return;
    }
    try {
    const password=pw;
    const response = await fetch(BACKEND_URL+"/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password }),
      credentials: "include" // 세션 쿠키 포함
    });

    const data = await response.json();
    if (response.ok){
        alert(`로그인 성공! ${data.username}`);
            window.location.href = "../index.html";
    }
    else{
        alert(`로그인 실패: ${data.error}`);
    }
  } catch (err) {
    alert("서버 요청 실패: " + err.message);
  }

  });
</script>
</body>
</html>
